<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
</head>

<body>
    <div id="app">
    </div>
</body>
<script>
// 沙箱
function compileCode(src) {
  src = `with (proxyObj){\n let window = this;\n ${src}\n}`
  return new Function('proxyObj', src)
}

function proxyObj(target) {
  let window = { webpackJsonp:null }
  let ignoreList = [
    'setTimeout',
    'clearTimeout',
    'setInterval',
    'requestAnimationFrame',
    'cancelAnimationFrame',
    'addEventListener',
    'getComputedStyle',
    ]
  let proxyObj = new Proxy(target, {
    get(target, key) {
      if (key === Symbol.unscopables) {
        return undefined;
      }   
      console.log('getter:','window.'+key);
      if (ignoreList.includes(key)) {
        return Reflect.get(target, key).bind(null)
      }
      if (key === 'window' || key === 'self') {
        return window
      }
      return Reflect.get(window, key) || Reflect.get(target, key)
    },
    has(target, key){
        return true
    },
    set(target, key, value) {
      console.log(`setter:${key}=${value}`)
      // let ignoreList = ['webpackJsonp']
      let ignoreList = []
      Reflect.set(window, key, value)
      return true
    },
    defineProperty: function(target, prop, descriptor) {
      !descriptor.writable && console.error('禁止子应用在window中定义writable为false的变量;这会造成子应用在第二次打开发生redefine错误')
      return Reflect.defineProperty(target, prop, descriptor)
    },
  })
  return proxyObj
}

function createSandbox(src, target) {
  let proxy = proxyObj(target)
  compileCode(src).call(proxy, proxy)
}

// 在沙箱中运行测试代码
let source = `!(function(r) {
  console.log('最先执行的js');
  var n = window.webpackJsonp;
  window.webpackJsonp = function(e, u, c) {
    for (var p, f, i, a = 0, l = []; a < e.length; a++)
      (f = e[a]), o[f] && l.push(o[f][0]), (o[f] = 0);
    for (p in u) Object.prototype.hasOwnProperty.call(u, p) && (r[p] = u[p]);
    for (n && n(e, u, c); l.length; ) l.shift()();
    if (c) for (a = 0; a < c.length; a++) i = t((t.s = c[a]));
    return i;
  };
  var e = {},
    o = { 2: 0 };
  function t(n) {
    if (e[n]) return e[n].exports;
    var o = (e[n] = { i: n, l: !1, exports: {} });
    return r[n].call(o.exports, o, o.exports, t), (o.l = !0), o.exports;
  }
  (t.m = r),
    (t.c = e),
    (t.d = function(r, n, e) {
      t.o(r, n) ||
        Object.defineProperty(r, n, {
          configurable: !1,
          enumerable: !0,
          get: e
        });
    }),
    (t.n = function(r) {
      var n =
        r && r.__esModule
          ? function() {
              return r.default;
            }
          : function() {
              return r;
            };
      return t.d(n, "a", n), n;
    }),
    (t.o = function(r, n) {
      return Object.prototype.hasOwnProperty.call(r, n);
    }),
    (t.p = "/app1"),
    (t.oe = function(r) {
      throw (console.error(r), r);
    });
})([]);
webpackJsonp({},[],[])`

let sandbox = createSandbox(source,window)
</script>

</html>